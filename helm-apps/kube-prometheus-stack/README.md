# install-kube-prometheus-stack

<!-- TOC -->

- [install-kube-prometheus-stack](#install-kube-prometheus-stack)
- [Requirements](#requirements)
- [Accessing Prometheus](#accessing-prometheus)
- [Troubleshooting of Prometheus installation](#troubleshooting-of-prometheus-installation)
- [Accessing AlertManager](#accessing-alertmanager)
- [Accessing Grafana](#accessing-grafana)
- [References](#references)

<!-- TOC -->

# Requirements

- Install all packages and binaries following the instructions on the [REQUIREMENTS.md](../../REQUIREMENTS.md) file.
- Create the cluster following the instructions on the [README.md](../../README.md#create-the-cluster-and-deploy-applications) file.

# Accessing Prometheus

If needs add entry in ``/etc/hosts`` file:

> ATTENTION!!! You must be connected to the kind cluster

```bash
kubectl wait --for=create ingress/monitor-mycompany-prometheus --timeout=900s -n monitoring
export IP=$(kubectl get ing monitor-mycompany-prometheus -n monitoring -o json | jq -r .status.loadBalancer.ingress[].ip)
sudo grep -qxF "$IP  prometheus.mycompany.com" /etc/hosts || sudo sh -c "echo '$IP  prometheus.mycompany.com' >> /etc/hosts"
```

Open the browser and access the URL: https://prometheus.mycompany.com/

# Troubleshooting of Prometheus installation

List the resources.

```bash
kubectl get all -n monitoring
```

See the status of the pod with the following command:

```bash
kubectl --namespace monitoring get pods -l "release=monitor"
```

See the Prometheus log with the following command:

```bash
kubectl logs -f prometheus-monitor-mycompany-prometheus-0 -c prometheus -n monitoring
```

Commands needed to directly perform or debug any promised content for the ``prometheus-monitor-mycompany-prometheus-0`` pod in namespace ``monitoring`` each Kubernetes clusters.

```bash
kubectl exec -it prometheus-monitor-mycompany-prometheus-0 -n monitoring -- sh
```

See configuration file of Prometheus inside Pod generated by Prometheus-Operator:

```bash
cat /etc/prometheus/config_out/prometheus.env.yaml

ls /etc/prometheus/rules/*
```

See resources of pods in use:

```bash
kubectl describe pod/prometheus-monitor-mycompany-prometheus-0 -n monitoring

kubectl top pods -n monitoring

kubectl top nodes -n monitoring
```

More informations about Throubleshooting in Prometheus-Operator are available [in this page](https://github.com/coreos/prometheus-operator/blob/master/Documentation/troubleshooting.md)

# Accessing AlertManager

If needs add entry in ``/etc/hosts`` file:

> ATTENTION!!! You must be connected to the kind cluster

```bash
kubectl wait --for=create ingress/monitor-mycompany-alertmanager --timeout=900s -n monitoring
export IP=$(kubectl get ing monitor-mycompany-alertmanager -n monitoring -o json | jq -r .status.loadBalancer.ingress[].ip)
sudo grep -qxF "$IP  alertmanager.mycompany.com" /etc/hosts || sudo sh -c "echo '$IP  alertmanager.mycompany.com' >> /etc/hosts"
```

Open the browser and access the URL: https://alertmanager.mycompany.com/

# Accessing Grafana

If needs add entry in ``/etc/hosts`` file:

> ATTENTION!!! You must be connected to the kind cluster

```bash
kubectl wait --for=create ingress/monitor-grafana --timeout=900s -n monitoring
export IP=$(kubectl get ing monitor-grafana -n monitoring -o json | jq -r .status.loadBalancer.ingress[].ip)
sudo grep -qxF "$IP  grafana.mycompany.com" /etc/hosts || sudo sh -c "echo '$IP  grafana.mycompany.com' >> /etc/hosts"
```

Open the browser and access the URL: https://grafana.mycompany.com/

- **login**: admin
- **password**: prom-operator

Reference: https://dev.to/rayandasoriya/comment/dckk

Dashboards to import:

- [../kube-pires/kube-pires-dashboard.json](../kube-pires/kube-pires-dashboard.json)
- https://grafana.com/grafana/dashboards/10229
- https://grafana.com/grafana/dashboards/11040
- https://grafana.com/grafana/dashboards/11039
- https://grafana.com/grafana/dashboards/11038

# References

- https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack

More info about prometheus-operator can find in follow pages.

- https://github.com/prometheus-operator/kube-prometheus
- https://github.com/prometheus-operator/prometheus-operator
- https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/
- https://prometheus-operator.dev/
- https://devops.college/prometheus-operator-how-to-monitor-an-external-service-3cb6ac8d5acb
- https://blog.sebastian-daschner.com/entries/prometheus-kubernetes-operator
- https://kruschecompany.com/kubernetes-prometheus-operator/
- https://containerjournal.com/topics/container-management/cluster-monitoring-with-prometheus-operator/
- https://sysdig.com/blog/kubernetes-monitoring-prometheus/
- https://sysdig.com/blog/kubernetes-monitoring-with-prometheus-alertmanager-grafana-pushgateway-part-2/
- https://sysdig.com/blog/kubernetes-monitoring-prometheus-operator-part3/

About config parameters of prometheus-operator:

- https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md
- https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#remotewritespec
- https://prometheus.io/docs/prometheus/latest/configuration/configuration/#remote_write
- https://www.robustperception.io/dropping-metrics-at-scrape-time-with-prometheus

